# Dockerfile â€” builds myapp.ear using javac/jar inside image (JDK 8)
FROM openjdk:8 AS builder
 
WORKDIR /work
COPY . /work
 
# create folders
RUN mkdir -p build/classes /work/dist /work/temp/war /work/temp/ear
 
# compile java sources if present (target/source 1.8)
RUN if [ -d src ]; then \
      find src -name "*.java" > /work/sources.txt || true; \
      if [ -s /work/sources.txt ]; then \
        javac -d build/classes -source 1.8 -target 1.8 -cp "lib/*" @/work/sources.txt || true; \
      fi; \
    fi
 
# prepare war (WebContent + compiled classes + WEB-INF/lib)
RUN if [ -d WebContent ]; then cp -r WebContent/* /work/temp/war/ || true; fi && \
    mkdir -p /work/temp/war/WEB-INF/classes && \
    if [ -d build/classes ]; then cp -r build/classes/* /work/temp/war/WEB-INF/classes/ || true; fi && \
    if [ -d lib ]; then mkdir -p /work/temp/war/WEB-INF/lib && cp -r lib/*.jar /work/temp/war/WEB-INF/lib/ 2>/dev/null || true; fi && \
    cd /work/temp/war && jar -cvf /work/dist/myapp.war . || true
 
# prepare ear (include META-INF if exists)
RUN mkdir -p /work/temp/ear && cp /work/dist/myapp.war /work/temp/ear/ || true && \
    if [ -d META-INF ]; then cp -r META-INF/* /work/temp/ear/META-INF/ || true; fi && \
    cd /work/temp/ear && jar -cvf /work/dist/myapp.ear . || true
 
# final: the built .ear is at /work/dist/myapp.ear inside this image