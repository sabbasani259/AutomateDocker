version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto8
    commands:
      - echo "Installing dependencies..."
      - java -version

  pre_build:
    commands:
      - echo "Starting pre-build phase..."
      - mkdir -p build/classes
      - mkdir -p lib

      # Logging (Log4j)
      - wget https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.20.0/log4j-core-2.20.0.jar -O lib/log4j-core-2.20.0.jar
      - wget https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-api/2.20.0/log4j-api-2.20.0.jar -O lib/log4j-api-2.20.0.jar

      # Hibernate
      - wget https://repo1.maven.org/maven2/org/hibernate/hibernate-core/5.6.15.Final/hibernate-core-5.6.15.Final.jar -O lib/hibernate-core-5.6.15.Final.jar

      # JSON libraries
      - wget https://repo1.maven.org/maven2/com/googlecode/json-simple/json-simple/1.1.1/json-simple-1.1.1.jar -O lib/json-simple-1.1.1.jar
      - wget https://repo1.maven.org/maven2/com/google/code/gson/gson/2.10.1/gson-2.10.1.jar -O lib/gson-2.10.1.jar

      # Jackson 1.x (for org.codehaus.jackson)
      - wget https://repo1.maven.org/maven2/org/codehaus/jackson/jackson-mapper-asl/1.9.13/jackson-mapper-asl-1.9.13.jar -O lib/jackson-mapper-asl-1.9.13.jar
      - wget https://repo1.maven.org/maven2/org/codehaus/jackson/jackson-core-asl/1.9.13/jackson-core-asl-1.9.13.jar -O lib/jackson-core-asl-1.9.13.jar

      # JAX-RS API
      - wget https://repo1.maven.org/maven2/javax/ws/rs/javax.ws.rs-api/2.1/javax.ws.rs-api-2.1.jar -O lib/javax.ws.rs-api-2.1.jar

      # Commons IO & Codec
      - wget https://repo1.maven.org/maven2/commons-io/commons-io/2.11.0/commons-io-2.11.0.jar -O lib/commons-io-2.11.0.jar
      - wget https://repo1.maven.org/maven2/commons-codec/commons-codec/1.15/commons-codec-1.15.jar -O lib/commons-codec-1.15.jar

      # RabbitMQ
      - wget https://repo1.maven.org/maven2/com/rabbitmq/amqp-client/5.16.0/amqp-client-5.16.0.jar -O lib/amqp-client-5.16.0.jar

      # JasperReports
      - wget https://repo1.maven.org/maven2/net/sf/jasperreports/jasperreports/6.20.0/jasperreports-6.20.0.jar -O lib/jasperreports-6.20.0.jar

      # JavaMail (javax.mail and activation)
      - wget https://repo1.maven.org/maven2/com/sun/mail/javax.mail/1.6.2/javax.mail-1.6.2.jar -O lib/javax.mail-1.6.2.jar
      - wget https://repo1.maven.org/maven2/javax/activation/activation/1.1.1/activation-1.1.1.jar -O lib/activation-1.1.1.jar

      # JMS API
      - wget https://repo1.maven.org/maven2/javax/jms/javax.jms-api/2.0.1/javax.jms-api-2.0.1.jar -O lib/javax.jms-api-2.0.1.jar

      # Kafka (old consumer API and dependencies)
      - wget https://repo1.maven.org/maven2/org/apache/kafka/kafka_2.12/0.10.2.2/kafka_2.12-0.10.2.2.jar -O lib/kafka_2.12-0.10.2.2.jar
      - wget https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/0.10.2.2/kafka-clients-0.10.2.2.jar -O lib/kafka-clients-0.10.2.2.jar
      - wget https://repo1.maven.org/maven2/org/scala-lang/scala-library/2.12.1/scala-library-2.12.1.jar -O lib/scala-library-2.12.1.jar

      # Guava
      - wget https://repo1.maven.org/maven2/com/google/guava/guava/31.1-jre/guava-31.1-jre.jar -O lib/guava-31.1-jre.jar

      # MySQL JDBC Driver
      - wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.49/mysql-connector-java-5.1.49.jar -O lib/mysql-connector-java-5.1.49.jar

      # Jedis (Redis client)
      - wget https://repo1.maven.org/maven2/redis/clients/jedis/3.7.1/jedis-3.7.1.jar -O lib/jedis-3.7.1.jar
      - wget https://repo1.maven.org/maven2/org/apache/commons/pool2/commons-pool2/2.11.1/commons-pool2-2.11.1.jar -O lib/commons-pool2-2.11.1.jar

      # JXL (Java Excel API)
      - wget https://repo1.maven.org/maven2/net/sourceforge/jexcelapi/jxl/2.6.12/jxl-2.6.12.jar -O lib/jxl-2.6.12.jar

      # ANTLR v3
      - wget https://repo1.maven.org/maven2/org/antlr/antlr/3.5.2/antlr-3.5.2.jar -O lib/antlr-3.5.2.jar

      # Apache Commons Lang
      - wget https://repo1.maven.org/maven2/commons-lang/commons-lang/2.6/commons-lang-2.6.jar -O lib/commons-lang-2.6.jar

      # Servlet API
      - wget https://repo1.maven.org/maven2/javax/servlet/javax.servlet-api/3.1.0/javax.servlet-api-3.1.0.jar -O lib/javax.servlet-api-3.1.0.jar

      # Compile with all dependencies
      - find src -name "*.java" > sources.txt
      - cat sources.txt
      - javac -encoding ISO-8859-1 -d build/classes -cp "lib/*" @sources.txt

  build:
    commands:
      - echo "Building EAR file..."
      - mkdir -p build/ear
      - cp -r WebContent/* build/ear/
      - cd build/ear
      - jar -cvf application.ear *
      - ls -l application.ear
      - cd ../..
      - echo "EAR file created successfully."

  post_build:
    commands:
      - echo "Uploading EAR file to S3..."
      - |
        BUCKET_NAME=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'ap-south-1')].Name | [0]" --output text)
        aws s3 cp build/ear/application.ear s3://$BUCKET_NAME/
      - echo "Upload completed."

artifacts:
  files:
    - build/ear/application.ear
  discard-paths: yes
